<title>Breakout en JS</title>

<style>
    body {
        background-color: #111;
    }

    canvas {
        border: 4px solid #fff;
        border-bottom: transparent;
        /* background: #000; */
        background: url("/assets/bkg.png") no-repeat fixed center;
        margin: 0 auto;
        display: block;
    }
</style>
<img hidden id="sprites" src="/assets/sprites.png" alt="sprite arkanoid">

<canvas></canvas>

<script>
    const canvas = document.querySelector("canvas")
    const ctx = canvas.getContext("2d")

    const $sprite = document.getElementById("sprites")
    canvas.width = 448
    canvas.height = 400

    let counter = 0
    let reloadFix = false

    /* VARIABLES DE LA BOLA */
    const ballRadius = 5;
    //Posicion de la bola
    let x = canvas.width / 2;
    let y = canvas.height - 30 - ballRadius;
    //Velocidad de la bola
    let dx = 1;
    let dy = -1;//negativo arriva, positivo abajo

     /* VARIABLES DE LA PALETA */
    const paddleHeight = 10;
    const paddleWidth = 50;

    let paddleX = (canvas.width - paddleWidth) / 2
    let paddleY = (canvas.height - paddleHeight - 10 )

    let rightPressed = false
    let leftPressed = false

    let paddleSensitibity = 3

    /* VARIABLES DE LOS LADRILLOS */
    const brickRowCount = 1;
    const brickColumnCount = 1;
    const brickWidth = 30;
    const brickHeight = 14;
    const brickPadding = 2;
    const BrickOffsetTop = 80;
    const BrickOffsetLeft = 16;
    const bricks = []

    const brickStatus = {
        ACTIVE:1, 
        DESTROYED:0
    }

    for(let c = 0; c < brickColumnCount; c++){
        bricks[c]= []
        for (let r = 0; r < brickRowCount; r++) {
            //calcula la posicion del ladrillo en pantalla
            const brickX = c * (brickWidth + brickPadding)+ 
            BrickOffsetLeft
            const brickY = r * (brickHeight + brickPadding)+ 
            BrickOffsetTop
            //Asignar color aleatorio al ladrillo
            const random = Math.floor(Math.random() * 8)
            // guardamos la info de cala ladrillo
            bricks[c][r]= {
                x: brickX,
                y: brickY, 
                status: brickStatus.ACTIVE,
                color: random
            }

            
        }
    }


    function drawBall() {
        ctx.beginPath()
        ctx.arc(x, y, ballRadius, 0, Math.PI * 2)
        ctx.fillStyle = "#fff"
        ctx.fill()

    }
    function drawPaddle() {
        // ctx.fillStyle="#09f"
        // ctx.fillRect(
        //     paddleX,        //coordenada x
        //     paddleY,        //coordenada y
        //     paddleWidth,    //ancho
        //     paddleHeight    //alto
        // )
        ctx.drawImage(
            $sprite,        //imagen
            29,             //clipX: coords de recorte
            174,            //clipY: coords de recorte
            paddleWidth,    //Tamaño del recorte
            paddleHeight,   //Tamaño del recorte
            paddleX,        //posicion x del dibujo
            paddleY,        //posicion y del dibujo
            paddleWidth,    //ancho x del dibujo
            paddleHeight,   //alto y del dibujo

        )
    }
    function drawBricks() {
        for(let c = 0; c < brickColumnCount; c++){
            for (let r = 0; r < brickRowCount; r++) {
                const currentBrick =  bricks[c][r]
                if(currentBrick.status == brickStatus.DESTROYED){
                    continue;
                }
                
                
                // ctx.fillStyle = "yellow"
                ctx.rect(
                    currentBrick.x,
                    currentBrick.y,
                    brickWidth,
                    brickHeight
                )
                ctx.stroke()
                // ctx.fill()

                const clipX = 30 + (currentBrick.color * 16) 
                // 16 es el tamaño de ancho del sprite
                // y 30 el ancho hasta el primer elemento
                
                ctx.drawImage(
                    $sprite,
                    clipX,
                    83,
                    15,
                    7,
                    currentBrick.x,
                    currentBrick.y,
                    brickWidth,
                    brickHeight
                )
            }
        }
    }
    function collisionDetection() {
        for(let c = 0; c < brickColumnCount; c++){
            for (let r = 0; r < brickRowCount; r++) {
                const currentBrick =  bricks[c][r]
                if(currentBrick.status == brickStatus.DESTROYED){
                    continue;
                }

                const isBallSameXAsBrick = 
                    x>currentBrick.x && 
                    x<currentBrick.x+brickWidth

                const isBallSameYAsBrick = 
                    y>currentBrick.y && 
                    y<currentBrick.y+brickHeight

                if (isBallSameXAsBrick && isBallSameYAsBrick) {
                    dy = -dy;
                    currentBrick.status = brickStatus.DESTROYED
                }
            }
        }
    }
    function ballMovement() {
        //rebotar bola en laterales
        if (
            x + dx > canvas.width - ballRadius ||
            x + dx < ballRadius
        ) {
            dx = -dx
        }
        //rebotar bola arriba
        if ( y + dy < ballRadius ) {
            dy = -dy
        }
        //bola abajo, pala o game over
        const isBallSameAsPaddle = 
        x>paddleX && 
        x<paddleX+paddleWidth

        const isBallTouchingPaddle = 
        y>paddleY && 
        y<paddleY+paddleHeight

        if(isBallSameAsPaddle && isBallTouchingPaddle){
            dy = -dy
        }
        else if ( y + dy > canvas.height - ballRadius ) {
            console.log("Game Over");
            reloadFix=true
            document.location.reload()

        }

        x += dx
        y += dy
    }
    function paddleMovement() {

        if(rightPressed & paddleX < canvas.width - paddleWidth ){
            paddleX += paddleSensitibity;
        }else if (leftPressed  & paddleX > 0 ){
            paddleX -= paddleSensitibity;
        }

    }
    function cleanCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)
    }
    function initEvents() {
        document.addEventListener("keydown",keyDownHandler)
        document.addEventListener("keyup",keyUpHandler)

        function keyDownHandler(event) {
            const {key}= event
            if(key == "Right" || key == "ArrowRight"){
                rightPressed = true
            }else if (key == "Left" || key == "ArrowLeft"){
                leftPressed = true
            }
        }
        function keyUpHandler(event) {
            const {key}= event
            if(key == "Right" || key == "ArrowRight"){
                rightPressed = false
            }else if (key == "Left" || key == "ArrowLeft"){
                leftPressed = false
            }
        }

    }
    function draw() {
        cleanCanvas()
        //dibujar elementos
        drawBall()
        drawPaddle()
        drawBricks()
        //drawScore()

        //colisiones y movimientos

        collisionDetection()
        ballMovement()
        paddleMovement()
        console.log("hola");
        if (reloadFix){return}
        if(bricks.filter(b=>b.find(f=>f.status == brickStatus.ACTIVE)  ).length == 0){
            console.log("WIN!!!!!")
            return;
        }
        window.requestAnimationFrame(draw)
    }
    draw()
    initEvents()


</script>